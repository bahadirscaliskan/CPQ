<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profesyonel Teklif Sistemi</title>
    <style>
        :root {
            --primary: #203764;      /* Ana Lacivert */
            --secondary: #4472c4;    /* Excel Mavisi */
            --active-bg: #d1e7dd;    /* Aktif kolon arka planÄ± */
            --active-border: #198754;/* Aktif kolon kenarlÄ±ÄŸÄ± */
            --custom-bg: #fff0f0;    /* Manuel giriÅŸ arka planÄ± */
            --bg: #f4f6f9;           /* Sayfa arka planÄ± */
            --dark-footer: #343a40;  /* Alt KÄ±sÄ±m Koyu Renk */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            font-size: 13px;
            color: #333;
        }

        /* --- SOL PANEL --- */
        .sidebar {
            width: 320px;
            background: white;
            border-right: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 10px rgba(0,0,0,0.03);
            z-index: 10;
        }

        .header {
            background: var(--primary);
            color: white;
            padding: 18px;
            text-align: center;
            font-weight: 700;
            font-size: 1.2em;
            letter-spacing: 0.5px;
        }

        .scroll-y { overflow-y: auto; flex: 1; padding-bottom: 20px; }

        .group-title {
            background: #e9ecef;
            color: #495057;
            padding: 10px 20px;
            font-weight: 800;
            font-size: 0.85em;
            text-transform: uppercase;
            border-bottom: 1px solid #dee2e6;
            margin-top: 10px;
        }

        .input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 20px;
            border-bottom: 1px solid #f1f3f5;
            transition: background 0.2s;
        }
        .input-row:hover { background: #f8f9fa; }
        
        .qty-input {
            width: 60px;
            padding: 6px;
            text-align: center;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-weight: bold;
            color: var(--primary);
            font-size: 1.1em;
        }
        .qty-input:focus { outline: 2px solid var(--secondary); border-color: transparent; }

        .group-total-row {
            background: #f1f5f9;
            color: var(--primary);
            padding: 6px 20px;
            font-weight: bold;
            font-size: 0.9em;
            text-align: right;
            border-bottom: 1px solid #dee2e6;
        }

        /* Sol Alt Kutu */
        .summary-box {
            padding: 20px;
            background: var(--dark-footer);
            color: white;
            text-align: center;
            border-top: 1px solid #4b545c;
            display: flex;
            flex-direction: column;
            justify-content: center;
            /* YÃ¼kseklik sabitleme (Hizalama iÃ§in) */
            height: 110px; 
            box-sizing: border-box;
        }

        /* --- SAÄ PANEL --- */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            overflow: hidden;
        }

        .top-bar {
            padding: 15px 30px;
            background: #fff;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }

        .platform-info {
            background: #e3f2fd;
            color: #0d47a1;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: bold;
            border: 1px solid #bbdefb;
        }

        .content {
            flex: 1;
            padding: 30px;
            overflow: auto;
            background: #f4f6f9;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.04);
            margin-bottom: 30px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .card-header {
            background: var(--primary);
            color: white;
            padding: 12px 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1em;
        }

        .btn-add {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 0.8em;
            cursor: pointer;
            font-weight: bold;
        }

        .del-cell { color: #dc3545; cursor: pointer; font-weight: bold; font-size: 1.2em; text-align: center; }

        table { width: 100%; border-collapse: collapse; text-align: center; }
        
        th {
            background: #f8f9fa;
            color: #555;
            padding: 12px 8px;
            font-size: 0.85em;
            border: 1px solid #dee2e6;
            vertical-align: middle;
            font-weight: 700;
        }

        td {
            padding: 8px 8px;
            border: 1px solid #f1f1f1;
            vertical-align: middle;
        }

        .ref-price {
            background: #f1f3f5;
            color: #666;
            font-family: 'Consolas', monospace;
            font-weight: bold;
            border: none;
            width: 100%;
            text-align: right;
            padding-right: 5px;
        }

        .price-input {
            width: 85%;
            text-align: right;
            border: 1px solid #e0e0e0;
            padding: 6px;
            border-radius: 4px;
            color: #333;
            background: white;
            font-family: 'Consolas', monospace;
        }
        
        .active-col {
            background-color: var(--active-bg) !important;
            border-left: 2px solid var(--active-border);
            border-right: 2px solid var(--active-border);
        }
        .active-col .price-input {
            border-color: var(--active-border);
            font-weight: bold;
            background: #fff;
            color: #0f5132;
        }

        .custom-col { background-color: var(--custom-bg); border-left: 2px solid #dc3545; }
        .custom-input { 
            width: 42%; padding: 5px; border: 1px solid #e0e0e0; 
            border-radius: 3px; text-align: center; font-weight: bold; font-size: 0.9em;
        }
        
        .inp-flat { border: none; width: 100%; text-align: left; font-weight: 600; color: #333; }
        .row-total { font-weight: 800; text-align: right; padding-right: 15px; font-size: 1.1em; color: var(--primary); font-family: 'Consolas', monospace;}
        .multiplier-badge { display: inline-block; background: #e2e8f0; color: #475569; font-size: 0.75em; border-radius: 12px; padding: 2px 8px; margin-top: 4px; }

        .card-footer-summary {
            background: #fafbfc;
            border-top: 1px solid #dee2e6;
            padding: 15px 20px;
            display: flex;
            justify-content: flex-end;
            gap: 40px;
        }
        .card-stat { text-align: right; border-left: 3px solid var(--secondary); padding-left: 15px; }
        .card-stat small { display: block; font-size: 0.75em; color: #888; text-transform: uppercase; font-weight:bold; }
        .card-stat span { display: block; font-size: 1.2em; color: #333; font-weight: 800; font-family: 'Consolas', monospace;}

        /* --- SAÄ ALT (FOOTER) - GÃœNCELLENDÄ° --- */
        .footer {
            background: var(--dark-footer); /* Sol ile aynÄ± koyu renk */
            border-top: 1px solid #4b545c;
            padding: 20px 40px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            z-index: 20;
            /* YÃ¼kseklik sabitleme (Sol tarafla aynÄ± hizaya gelmesi iÃ§in padding'i kutu iÃ§ine sÄ±ÄŸdÄ±rÄ±yoruz) */
            height: 110px;
            box-sizing: border-box;
            align-items: center; /* Ä°Ã§eriÄŸi dikey ortala */
        }

        .kpi { 
            text-align: center; 
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1); /* Åeffaf Beyaz */
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            height: 100%; /* Kutu yÃ¼ksekliÄŸini doldur */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .kpi small { 
            display: block; 
            font-size: 0.7em; 
            color: #ced4da; 
            text-transform: uppercase; 
            font-weight: 700; 
            margin-bottom: 5px;
        }
        .kpi div { 
            font-size: 1.4em; 
            font-weight: 800; 
            color: #fff; 
        }
        
        /* Highlight KutularÄ± (SarÄ±mtÄ±rak) */
        .highlight { 
            background: rgba(255, 193, 7, 0.15); 
            border-color: rgba(255, 193, 7, 0.3); 
        }
        .highlight div { color: #ffc107; } /* SarÄ± Metin */

        /* Drag Handle */
        .drag-handle { cursor: grab; color: #aaa; font-size: 1.2em; width: 30px; user-select: none; }
        .drag-handle:active { cursor: grabbing; }
        .dragging { opacity: 0.5; background-color: #f0f0f0; border: 2px dashed #999; }

    </style>
</head>
<body>

<div class="sidebar">
    <div class="header">Ã–ÄRENCÄ° GÄ°RÄ°ÅÄ°</div>
    
    <div class="scroll-y">
        <div class="group-title">OKUL Ã–NCESÄ°</div>
        <div class="input-row"><label>0. SÄ±nÄ±f</label><input type="number" id="s0" class="qty-input" value="0" min="0" oninput="calculateAll()"></div>
        <div class="group-total-row">Toplam: <span id="sub_pre">0</span></div>

        <div class="group-title">Ä°LKOKUL (1-4)</div>
        <div class="input-row"><label>1. SÄ±nÄ±f</label><input type="number" id="s1" class="qty-input" value="0" min="0" oninput="calculateAll()"></div>
        <div class="input-row"><label>2. SÄ±nÄ±f</label><input type="number" id="s2" class="qty-input" value="0" min="0" oninput="calculateAll()"></div>
        <div class="input-row"><label>3. SÄ±nÄ±f</label><input type="number" id="s3" class="qty-input" value="0" min="0" oninput="calculateAll()"></div>
        <div class="input-row"><label>4. SÄ±nÄ±f</label><input type="number" id="s4" class="qty-input" value="0" min="0" oninput="calculateAll()"></div>
        <div class="group-total-row">Ä°lkokul Toplam: <span id="sub_primary">0</span></div>

        <div class="group-title">ORTAOKUL (5-8)</div>
        <div class="input-row"><label>5. SÄ±nÄ±f</label><input type="number" id="s5" class="qty-input" value="0" min="0" oninput="calculateAll()"></div>
        <div class="input-row"><label>6. SÄ±nÄ±f</label><input type="number" id="s6" class="qty-input" value="0" min="0" oninput="calculateAll()"></div>
        <div class="input-row"><label>7. SÄ±nÄ±f</label><input type="number" id="s7" class="qty-input" value="0" min="0" oninput="calculateAll()"></div>
        <div class="input-row"><label>8. SÄ±nÄ±f</label><input type="number" id="s8" class="qty-input" value="0" min="0" oninput="calculateAll()"></div>
        <div class="group-total-row">Ortaokul Toplam: <span id="sub_middle">0</span></div>

        <div class="group-title">LÄ°SE (9-12)</div>
        <div class="input-row"><label>9. SÄ±nÄ±f</label><input type="number" id="s9" class="qty-input" value="0" min="0" oninput="calculateAll()"></div>
        <div class="input-row"><label>10. SÄ±nÄ±f</label><input type="number" id="s10" class="qty-input" value="0" min="0" oninput="calculateAll()"></div>
        <div class="input-row"><label>11. SÄ±nÄ±f</label><input type="number" id="s11" class="qty-input" value="0" min="0" oninput="calculateAll()"></div>
        <div class="input-row"><label>12. SÄ±nÄ±f</label><input type="number" id="s12" class="qty-input" value="0" min="0" oninput="calculateAll()"></div>
        <div class="group-total-row">Lise Toplam: <span id="sub_high">0</span></div>
    </div>

    <div class="summary-box">
        <small style="opacity:0.7; letter-spacing:1px; color:#ced4da;">TOPLAM Ã–ÄRENCÄ°</small>
        <div style="font-size:2.5em; font-weight:bold; margin-top:5px; color:#fff;" id="lblTotalStudents">0</div>
        <div style="color:#ffc107; margin-top:5px; font-weight:bold; font-size:0.9em;" id="lblRangeInfo">AralÄ±k: 0-250</div>
    </div>
</div>

<div class="main">
    <div class="top-bar">
        <div class="platform-info">
            â„¹ï¸ Paket Bilgileri: <strong>TeknoPaket (399 â‚º)</strong> | <strong>MasterPaket (1050 â‚º)</strong>
        </div>
        <div style="color:#666; font-size:0.9em; text-align:right;">
            <div>* Ref. Birim FiyatÄ± deÄŸiÅŸtirerek tÃ¼m satÄ±rÄ± gÃ¼ncelleyebilirsiniz.</div>
            <div>* â˜° Ä°konundan tutarak satÄ±rlarÄ± sÄ±ralayabilirsiniz.</div>
        </div>
    </div>

    <div class="content">
        
        <div class="card">
            <div class="card-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span>ğŸ”¬ LAB PROJE SEÃ‡Ä°MÄ°</span>
                    <button class="btn-add" onclick="addNewRow('projects')">+ Ekle</button>
                </div>
                <small style="font-weight:normal; opacity:0.9;">Adet Ã‡arpanÄ± x Girilen Fiyat</small>
            </div>
            <table>
                <thead>
                    <tr>
                        <th width="30"></th>
                        <th width="20%" style="text-align:left; padding-left:15px;">PROJE ADI</th>
                        <th width="10%">REF. BÄ°RÄ°M FÄ°YAT</th>
                        
                        <th id="th_p_1" class="col-range">0-250<br><span class="multiplier-badge">x3 Adet</span></th>
                        <th id="th_p_2" class="col-range">251-500<br><span class="multiplier-badge">x6 Adet</span></th>
                        <th id="th_p_3" class="col-range">501-1000<br><span class="multiplier-badge">x9 Adet</span></th>
                        <th id="th_p_4" class="col-range">1000+<br><span class="multiplier-badge">x12 Adet</span></th>
                        
                        <th class="custom-col" width="12%">Ã–ZEL (MANUEL)<br><small>Adet & Fiyat</small></th>
                        <th width="12%">TOPLAM</th>
                        <th width="30"></th>
                    </tr>
                </thead>
                <tbody id="bodyProjects" class="sortable-list"></tbody>
            </table>
            <div class="card-footer-summary">
                <div class="card-stat"><small>Bu BÃ¶lÃ¼m ToplamÄ±</small><span id="sum_projects">0 â‚º</span></div>
                <div class="card-stat" style="border-left-color: #28a745;"><small>Ã–ÄŸrenci BaÅŸÄ± Ort.</small><span id="avg_projects">0 â‚º</span></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span>ğŸ›  LAB MALZEME SEÃ‡Ä°MÄ°</span>
                    <button class="btn-add" onclick="addNewRow('materials')">+ Ekle</button>
                </div>
                <small style="font-weight:normal; opacity:0.9;">Adet Ã‡arpanÄ± x Girilen Fiyat</small>
            </div>
            <table>
                <thead>
                    <tr>
                        <th width="30"></th>
                        <th width="20%" style="text-align:left; padding-left:15px;">MALZEME ADI</th>
                        <th width="10%">REF. BÄ°RÄ°M FÄ°YAT</th>
                        
                        <th id="th_m_1" class="col-range">4/1<br><span class="multiplier-badge">x6 Adet</span></th>
                        <th id="th_m_2" class="col-range">4/2<br><span class="multiplier-badge">x12 Adet</span></th>
                        <th id="th_m_3" class="col-range">4/3<br><span class="multiplier-badge">x18 Adet</span></th>
                        <th id="th_m_4" class="col-range">4/4<br><span class="multiplier-badge">x24 Adet</span></th>
                        
                        <th class="custom-col" width="12%">Ã–ZEL (MANUEL)<br><small>Adet & Fiyat</small></th>
                        <th width="12%">TOPLAM</th>
                        <th width="30"></th>
                    </tr>
                </thead>
                <tbody id="bodyMaterials" class="sortable-list"></tbody>
            </table>
            <div class="card-footer-summary">
                <div class="card-stat"><small>Bu BÃ¶lÃ¼m ToplamÄ±</small><span id="sum_materials">0 â‚º</span></div>
                <div class="card-stat" style="border-left-color: #28a745;"><small>Ã–ÄŸrenci BaÅŸÄ± Ort.</small><span id="avg_materials">0 â‚º</span></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span>ğŸ“¦ BÄ°REYSEL MALZEME</span>
                    <button class="btn-add" onclick="addNewRow('individual')">+ Ekle</button>
                </div>
                <small style="font-weight:normal; opacity:0.9;">Fiyat x SÄ±nÄ±f Mevcudu</small>
            </div>
            <table>
                <thead>
                    <tr>
                        <th width="30"></th>
                        <th width="40%" style="text-align:left; padding-left:15px;">ÃœRÃœN ADI</th>
                        <th width="15%">BÄ°RÄ°M FÄ°YAT</th>
                        <th width="15%">Ä°LGÄ°LÄ° SINIF / ADET</th>
                        <th width="20%">TOPLAM TUTAR</th>
                        <th width="30"></th>
                    </tr>
                </thead>
                <tbody id="bodyIndividual" class="sortable-list"></tbody>
            </table>
        </div>

    </div>

    <div class="footer">
        <div class="kpi">
            <small>TOPLAM MALZEME GÄ°DERÄ°</small>
            <div id="valMaterial">0 â‚º</div>
        </div>
        <div class="kpi">
            <small>PLATFORM GELÄ°RÄ°</small>
            <div id="valPlatform">0 â‚º</div>
        </div>
        <div class="kpi highlight">
            <small>MALÄ°YET + TEKNOPAKET (Ã–ÄŸr. BaÅŸÄ±)</small>
            <div id="valTekno">0 â‚º</div>
        </div>
        <div class="kpi highlight">
            <small>MALÄ°YET + MASTERPAKET (Ã–ÄŸr. BaÅŸÄ±)</small>
            <div id="valMaster">0 â‚º</div>
        </div>
    </div>
</div>

<script>
    const configProjects = { multipliers: [3, 6, 9, 12] };
    const configMaterials = { multipliers: [6, 12, 18, 24] };

    const dbProjects = [
        { name: "AKILLI ARABA", price: 2500 },
        { name: "HACÄ°M Ã–LÃ‡ER", price: 2500 },
        { name: "DÄ°NAMOMETRE", price: 2500 },
        { name: "KUÅ EVÄ°", price: 2500 },
        { name: "MÃœCEVHER KORUMA", price: 2500 },
        { name: "AKILLI KUMBARA", price: 2500 }
    ];

    const dbMaterials = [
        { name: "TURP", price: 1750 },
        { name: "KÃœMÃœLÃœS", price: 2000 },
        { name: "KIRMIZI KUTU", price: 2500 },
        { name: "SÄ°YAH KUTU", price: 3000 },
        { name: "Cubetto Robot", price: 8500 },
        { name: "Mbot Robot", price: 4500 },
        { name: "3B YazÄ±cÄ± Filament", price: 500 }
    ];

    const dbIndividual = [
        { name: "1.SINIF HELÄ°KOPTER YAPALIM", price: 175, targetClass: "s1" },
        { name: "1.SINIF Ã–RÃœMCEK YAPALIM", price: 175, targetClass: "s1" },
        { name: "2.SINIF RADYO YAPALIM", price: 175, targetClass: "s2" },
        { name: "2.SINIF UZAY UYDUSU", price: 175, targetClass: "s2" },
        { name: "3.SINIF ELEKTRÄ°K SÃœPÃœRGESÄ°", price: 200, targetClass: "s3" },
        { name: "3.SINIF TRAFÄ°K IÅIKLARI", price: 200, targetClass: "s3" },
        { name: "4.SINIF YÃœZÃœK PROJESÄ°", price: 200, targetClass: "s4" },
        { name: "4.SINIF ASANSÃ–R PROJESÄ°", price: 200, targetClass: "s4" }
    ];

    let currentLevelIndex = -1;

    window.onload = function() {
        renderTables();
        calculateAll(true);
        initDragAndDrop();
    };

    function renderTables() {
        const tbProj = document.getElementById("bodyProjects");
        dbProjects.forEach(p => {
            tbProj.insertAdjacentHTML('beforeend', createMatrixRow('projects', p.name, p.price));
        });

        const tbMat = document.getElementById("bodyMaterials");
        dbMaterials.forEach(m => {
            tbMat.insertAdjacentHTML('beforeend', createMatrixRow('materials', m.name, m.price));
        });

        const tbInd = document.getElementById("bodyIndividual");
        dbIndividual.forEach(i => {
            tbInd.insertAdjacentHTML('beforeend', createIndividualRow(i.name, i.price, i.targetClass, 0));
        });
    }

    function createMatrixRow(type, name, refPrice) {
        let prefix = type === 'projects' ? 'p' : 'm';
        let clsTot = type === 'projects' ? 'proj-total' : 'mat-total';
        let initVal = 0; 
        
        return `<tr draggable="true">
            <td class="drag-handle">â˜°</td>
            <td><input class="inp-flat" value="${name}" placeholder="ÃœrÃ¼n AdÄ±"></td>
            
            <td><input class="ref-price" value="${refPrice}" oninput="updateRowPrices(this)"></td>
            
            <td class="col-range col-0"><input type="number" min="0" class="price-input ${prefix}-price-0" value="${initVal}" oninput="calcTotalsOnly()"></td>
            <td class="col-range col-1"><input type="number" min="0" class="price-input ${prefix}-price-1" value="${initVal}" oninput="calcTotalsOnly()"></td>
            <td class="col-range col-2"><input type="number" min="0" class="price-input ${prefix}-price-2" value="${initVal}" oninput="calcTotalsOnly()"></td>
            <td class="col-range col-3"><input type="number" min="0" class="price-input ${prefix}-price-3" value="${initVal}" oninput="calcTotalsOnly()"></td>

            <td class="custom-col">
                <input type="number" min="0" class="custom-input custom-qty ${prefix}-cust-qty" placeholder="Adet" oninput="calcTotalsOnly()">
                <input type="number" min="0" class="custom-input custom-price ${prefix}-cust-price" placeholder="Fiyat" oninput="calcTotalsOnly()">
            </td>
            <td class="row-total ${clsTot}">0 â‚º</td>
            <td class="del-cell" onclick="delRow(this)">Ã—</td>
        </tr>`;
    }

    function createIndividualRow(name, price, target, qtyVal) {
        let options = `<option value="manual">Manuel</option>
            <option value="s0">0. SÄ±nÄ±f</option>
            <option value="s1">1. SÄ±nÄ±f</option>
            <option value="s2">2. SÄ±nÄ±f</option>
            <option value="s3">3. SÄ±nÄ±f</option>
            <option value="s4">4. SÄ±nÄ±f</option>
            <option value="s5">5. SÄ±nÄ±f</option>
            <option value="s6">6. SÄ±nÄ±f</option>
            <option value="s7">7. SÄ±nÄ±f</option>
            <option value="s8">8. SÄ±nÄ±f</option>`;
        
        if(target) options = options.replace(`value="${target}"`, `value="${target}" selected`);

        let isManual = !target || target === 'manual';
        let qtyAttr = isManual ? '' : 'readonly style="background:#eee;"';
        let val = qtyVal || 0;

        return `<tr data-target="${target || 'manual'}" draggable="true">
            <td class="drag-handle">â˜°</td>
            <td><input class="inp-flat" value="${name}" placeholder="ÃœrÃ¼n AdÄ±"></td>
            <td><input type="number" min="0" class="price-input ind-price" value="${price}" oninput="calcTotalsOnly()"></td>
            <td style="display:flex; gap:5px; align-items:center; justify-content:center;">
                <select style="width:80px; font-size:0.8em;" onchange="changeIndTarget(this)">${options}</select>
                <input type="number" min="0" class="qty-input ind-qty" value="${val}" ${qtyAttr} oninput="calcTotalsOnly()">
            </td>
            <td class="row-total ind-total">0 â‚º</td>
            <td class="del-cell" onclick="delRow(this)">Ã—</td>
        </tr>`;
    }

    function initDragAndDrop() {
        const lists = document.querySelectorAll('.sortable-list');
        lists.forEach(list => {
            list.addEventListener('dragstart', (e) => {
                if(e.target.tagName === 'TR') e.target.classList.add('dragging');
            });
            list.addEventListener('dragend', (e) => {
                if(e.target.tagName === 'TR') e.target.classList.remove('dragging');
            });
            list.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(list, e.clientY);
                const draggable = document.querySelector('.dragging');
                if (afterElement == null) list.appendChild(draggable);
                else list.insertBefore(draggable, afterElement);
            });
        });
    }

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('tr:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
            else return closest;
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function updateRowPrices(refInput) {
        let row = refInput.closest('tr');
        let newPrice = parseFloat(refInput.value) || 0;
        row.querySelectorAll('.price-input').forEach(inp => {
            if(!inp.classList.contains('ind-price')) inp.value = newPrice;
        });
        calcTotalsOnly();
    }

    function addNewRow(type) {
        let containerId = type === 'projects' ? 'bodyProjects' : (type === 'materials' ? 'bodyMaterials' : 'bodyIndividual');
        let rowHtml = type === 'projects' ? createMatrixRow('projects', '', 0) : 
                      (type === 'materials' ? createMatrixRow('materials', '', 0) : createIndividualRow('', 0, null, 0));
        
        document.getElementById(containerId).insertAdjacentHTML('beforeend', rowHtml);
        calculateAll(true);
    }

    function delRow(btn) {
        btn.closest('tr').remove();
        calcTotalsOnly();
    }

    function changeIndTarget(sel) {
        let row = sel.closest('tr');
        let val = sel.value;
        let qtyInp = row.querySelector('.ind-qty');
        
        row.setAttribute('data-target', val);
        
        if(val === 'manual') {
            qtyInp.removeAttribute('readonly');
            qtyInp.style.background = '#fff';
            qtyInp.value = 0;
        } else {
            qtyInp.setAttribute('readonly', true);
            qtyInp.style.background = '#eee';
        }
        calculateAll();
    }

    function calculateAll(forceUpdate = false) {
        let counts = {};
        const ids = ['s0','s1','s2','s3','s4','s5','s6','s7','s8','s9','s10','s11','s12'];
        let totalAll = 0;
        
        ids.forEach(id => {
            let el = document.getElementById(id);
            if(el.value < 0) el.value = 0;
            let val = parseInt(el.value) || 0;
            counts[id] = val;
            totalAll += val;
        });

        document.getElementById('sub_pre').innerText = counts['s0'];
        document.getElementById('sub_primary').innerText = counts['s1'] + counts['s2'] + counts['s3'] + counts['s4'];
        document.getElementById('sub_middle').innerText = counts['s5'] + counts['s6'] + counts['s7'] + counts['s8'];
        document.getElementById('sub_high').innerText = counts['s9'] + counts['s10'] + counts['s11'] + counts['s12'];
        document.getElementById('lblTotalStudents').innerText = totalAll;

        let levelIdx = 0;
        let rangeText = "0 - 250";
        if (totalAll > 1000) { levelIdx = 3; rangeText = "1000+"; }
        else if (totalAll > 500) { levelIdx = 2; rangeText = "501 - 1000"; }
        else if (totalAll > 250) { levelIdx = 1; rangeText = "251 - 500"; }
        
        document.getElementById("lblRangeInfo").innerText = "Aktif AralÄ±k: " + rangeText;

        if(levelIdx !== currentLevelIndex || forceUpdate) {
            currentLevelIndex = levelIdx;
            document.querySelectorAll('.active-col').forEach(el => el.classList.remove('active-col'));
            document.querySelectorAll('.col-range').forEach(el => {
                 if(el.classList.contains(`col-${levelIdx}`)) el.classList.add('active-col');
            });
            if(document.getElementById(`th_p_${levelIdx+1}`)) document.getElementById(`th_p_${levelIdx+1}`).classList.add('active-col');
            if(document.getElementById(`th_m_${levelIdx+1}`)) document.getElementById(`th_m_${levelIdx+1}`).classList.add('active-col');
        }

        document.querySelectorAll('#bodyIndividual tr').forEach(row => {
            let target = row.getAttribute('data-target');
            if(target && target !== 'manual') {
                let qty = counts[target] || 0;
                row.querySelector('.ind-qty').value = qty;
            }
        });

        calcTotalsOnly(totalAll);
    }

    function calcTotalsOnly(totalStudents = null) {
        if(totalStudents === null) totalStudents = parseInt(document.getElementById("lblTotalStudents").innerText);
        
        let grandMat = 0;
        let activeIdx = currentLevelIndex;
        let projSubTotal = 0;
        let matSubTotal = 0;

        document.querySelectorAll('#bodyProjects tr').forEach((row, i) => {
            let custQty = parseFloat(row.querySelector('.p-cust-qty').value);
            let custPrice = parseFloat(row.querySelector('.p-cust-price').value);
            let tot = 0;

            if(!isNaN(custQty) && !isNaN(custPrice) && custQty > 0) {
                if(custQty < 0) custQty = 0;
                if(custPrice < 0) custPrice = 0;
                tot = custQty * custPrice;
                row.querySelector('.proj-total').style.color = "#dc3545";
            } else {
                let elPrice = row.querySelector(`.p-price-${activeIdx}`);
                if(elPrice.value < 0) elPrice.value = 0;
                let price = parseFloat(elPrice.value) || 0;
                let multiplier = configProjects.multipliers[activeIdx];
                tot = price * multiplier;
                row.querySelector('.proj-total').style.color = "var(--primary)";
            }
            
            row.querySelector('.proj-total').innerText = fmt(tot);
            projSubTotal += tot;
        });

        document.querySelectorAll('#bodyMaterials tr').forEach((row, i) => {
            let custQty = parseFloat(row.querySelector('.m-cust-qty').value);
            let custPrice = parseFloat(row.querySelector('.m-cust-price').value);
            let tot = 0;

            if(!isNaN(custQty) && !isNaN(custPrice) && custQty > 0) {
                if(custQty < 0) custQty = 0;
                if(custPrice < 0) custPrice = 0;
                tot = custQty * custPrice;
                row.querySelector('.mat-total').style.color = "#dc3545";
            } else {
                let elPrice = row.querySelector(`.m-price-${activeIdx}`);
                if(elPrice.value < 0) elPrice.value = 0;
                let price = parseFloat(elPrice.value) || 0;
                let multiplier = configMaterials.multipliers[activeIdx];
                tot = price * multiplier;
                row.querySelector('.mat-total').style.color = "var(--primary)";
            }

            row.querySelector('.mat-total').innerText = fmt(tot);
            matSubTotal += tot;
        });

        let indSubTotal = 0;
        document.querySelectorAll('#bodyIndividual tr').forEach(row => {
            let pInput = row.querySelector('.ind-price');
            if(pInput.value < 0) pInput.value = 0;
            let price = parseFloat(pInput.value) || 0;
            let qty = parseInt(row.querySelector('.ind-qty').value) || 0;
            let tot = price * qty;
            row.querySelector('.ind-total').innerText = fmt(tot);
            indSubTotal += tot;
        });

        document.getElementById('sum_projects').innerText = fmt(projSubTotal);
        document.getElementById('avg_projects').innerText = totalStudents > 0 ? fmt(projSubTotal/totalStudents) : "0 â‚º";
        
        document.getElementById('sum_materials').innerText = fmt(matSubTotal);
        document.getElementById('avg_materials').innerText = totalStudents > 0 ? fmt(matSubTotal/totalStudents) : "0 â‚º";

        grandMat = projSubTotal + matSubTotal + indSubTotal;
        document.getElementById("valMaterial").innerText = fmt(grandMat);

        // Platform sabit fiyat hesaplama
        let platformTotal = totalStudents > 0 ? (totalStudents * 399) : 0; // VarsayÄ±lan Teknopaket (Ã–rnek)
        // Burada platform seÃ§imi kalktÄ±ÄŸÄ± iÃ§in sabit bir hesaplama veya sadece gÃ¶sterim yapabiliriz.
        // Ancak formÃ¼lde eski "platformSelect" referansÄ± var, onu dÃ¼zeltiyorum:
        document.getElementById("valPlatform").innerText = fmt(platformTotal);

        let perStudentCost = totalStudents > 0 ? (grandMat / totalStudents) : 0;
        document.getElementById("valTekno").innerText = fmt(perStudentCost + 399);
        document.getElementById("valMaster").innerText = fmt(perStudentCost + 1050);
    }

    function fmt(n) {
        return n.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' â‚º';
    }

</script>

</body>
</html>